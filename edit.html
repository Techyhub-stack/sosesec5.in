<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Edit Student Marks</title>
        <link rel="icon" href="assets/img/logo.png" type="image/x-icon">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f0f4f7;
      margin: 0;
      padding: 0;
    }
    .container {
      max-width: 650px;
      margin: 40px auto;
      background-color: #fff;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    }
    h2 {
      text-align: center;
      color: #0077cc;
      margin-bottom: 25px;
    }
    label {
      font-weight: 600;
      margin-top: 10px;
      display: block;
    }
    select, input[type="text"], input[type="number"] {
      width: 100%;
      padding: 10px;
      margin: 8px 0 20px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 15px;
    }
    button {
      width: 100%;
      padding: 12px;
      background-color: #0077cc;
      color: white;
      font-size: 16px;
      font-weight: 600;
      border: none;
      border-radius: 10px;
      cursor: pointer;
    }
    button:hover {
      background-color: #005fa3;
    }
    #editSection {
      display: none;
      background-color: #f9f9f9;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #ddd;
      margin-top: 30px;
    }
    .subjectRow {
      margin-bottom: 12px;
      padding: 10px;
      border: 1px dashed #ccc;
      border-radius: 8px;
    }
    #status, #addStatus {
      text-align: center;
      font-weight: bold;
      margin-top: 15px;
    }
  </style>
    </head>
    <body>
        <div class="container">
            <h2>Search & Edit Student Marks</h2>
            <form id="searchForm">
                <label>Select Class:</label>
                <select name="sheet" required>
                    <option value="">--Select Class--</option>
                    <option value="Class_10_A">Class 10 A</option>
                    <option value="Class_10_B">Class 10 B</option>
                    <option value="Class_11_A">Class 11 A</option>
                    <option value="Class_11_B">Class 11 B</option>
                    <option value="Class_12_A">Class 12 A</option>
                    <option value="Class_12_B">Class 12 B</option>
                </select>
                <label>Roll No:</label>
                <input type="text" name="rollNo" required placeholder="Enter Roll Number">
                <button type="submit">Search</button>
            </form>
            <div id="editSection"></div>
            <p id="status"></p>
            <hr style="margin: 40px 0;">
            <h2>Add New Student</h2>
            <form id="addStudentForm">
                <label>Select Class:</label>
                <select name="sheet" id="addClassSelect" required>
                    <option value="">--Select Class--</option>
                    <option value="Class_10_A">Class 10 A</option>
                    <option value="Class_10_B">Class 10 B</option>
                    <option value="Class_11_A">Class 11 A</option>
                    <option value="Class_11_B">Class 11 B</option>
                    <option value="Class_12_A">Class 12 A</option>
                    <option value="Class_12_B">Class 12 B</option>
                </select>
                <label>Roll No:</label>
                <input type="text" id="newRoll" required>
                <label>Name:</label>
                <input type="text" id="newName" required>
                <div id="subjectsContainer">
                    <div class="subjectRow">
                        <label>Subject:</label>
                        <input type="text" class="subjectInput" required>
                        <label>Marks:</label>
                        <input type="number" class="marksInput" required>
                    </div>
                </div>
                <button type="button" onclick="addSubjectRow()">+ Add Another Subject</button>
                <br>
                <br>
                <button type="submit">Add Student</button>
            </form>
            <p id="addStatus"></p>
        </div>
        <script>
const scriptURL = 'https://script.google.com/macros/s/AKfycbzKgR7UJUNFmNoj3GbFHUhO0qxJb858aNPp84zo184od3bTSHk1epkvM2exk-yaKlrHZw/exec'; // Replace with your actual URL

let currentClass = "", currentRoll = "", currentName = "";

document.getElementById("searchForm").addEventListener("submit", function (e) {
  e.preventDefault();
  const formData = new FormData(this);
  currentClass = formData.get("sheet");
  currentRoll = formData.get("rollNo");
  const url = `${scriptURL}?sheet=${currentClass}&rollNo=${currentRoll}`;

  fetch(url)
    .then(res => res.json())
    .then(records => {
      const editSection = document.getElementById("editSection");
      const status = document.getElementById("status");

      if (records.length > 0) {
        currentName = records[0].name;
        editSection.innerHTML = `<h3>Student: ${currentName} (Roll No: ${currentRoll})</h3><hr>`;

        records.forEach((rec, index) => {
          editSection.innerHTML += `
            <div class="subjectRow" id="subjRow-${rec.subject}">
              <strong>${rec.subject}</strong>:
              <input type="number" id="marks-${index}" value="${rec.marks}" style="width:80px;">
              <button onclick="updateMarks('${rec.rowIndex}', document.getElementById('marks-${index}').value)">Update</button>
              <button onclick="deleteSubject('${rec.subject}')">üóëÔ∏è Delete</button>
            </div>`;
        });

        editSection.innerHTML += `
          <hr>
          <h4>Add New Subject</h4>
          <label>Subject:</label>
          <input type="text" id="newSubjInput" placeholder="e.g., English">
          <label>Marks:</label>
          <input type="number" id="newSubjMarks" placeholder="e.g., 85">
          <button onclick="addNewSubject()">‚ûï Add Subject</button>
          <p id="addSubjStatus"></p>`;

        editSection.style.display = "block";
        status.innerText = "";
      } else {
        editSection.style.display = "none";
        status.innerText = "‚ö†Ô∏è Record Not Found.";
      }
    })
    .catch(err => {
      document.getElementById("editSection").style.display = "none";
      document.getElementById("status").innerText = "‚ùå Error: " + err.message;
    });
});

function updateMarks(rowIndex, newMarks) {
  const params = new URLSearchParams();
  params.append("sheet", currentClass);
  params.append("rowIndex", rowIndex);
  params.append("marks", newMarks);

  fetch(scriptURL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(data => {
      document.getElementById("status").innerText = data;
    });
}

function deleteSubject(subjectName) {
  if (!confirm(`Are you sure you want to delete subject "${subjectName}" for Roll No ${currentRoll}?`)) return;

  const url = `${scriptURL}?sheet=${currentClass}&rollNo=${currentRoll}&subject=${subjectName}`;

  fetch(url, {
    method: "GET"
  })
    .then(res => res.text())
    .then(data => {
      document.getElementById("status").innerText = data;
      const row = document.getElementById(`subjRow-${subjectName}`);
      if (row) row.remove();
    });
}

function addNewSubject() {
  const subject = document.getElementById("newSubjInput").value.trim();
  const marks = document.getElementById("newSubjMarks").value.trim();

  if (!subject || !marks) {
    document.getElementById("addSubjStatus").innerText = "‚ùó Please enter both subject and marks.";
    return;
  }

  const params = new URLSearchParams();
  params.append("sheet", currentClass);
  params.append("rollNo", currentRoll);
  params.append("name", currentName);
  params.append("subjects", JSON.stringify([{ subject, marks }]));

  fetch(scriptURL, {
    method: "POST",
    body: params
  })
    .then(res => res.text())
    .then(data => {
      document.getElementById("addSubjStatus").innerText = data;
    });
}
</script>
    </body>
</html>

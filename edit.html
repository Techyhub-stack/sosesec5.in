<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Edit Student Record</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
        <style>
    body { background: #f8f9fa; font-family: 'Segoe UI', sans-serif; padding: 2rem; }
    .form-section { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); animation: fadeIn 0.5s ease-in; }
    .subject-row { display: flex; gap: 10px; margin-bottom: 10px; }
    .subject-row input { flex: 1; }
    .photo-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 50%; border: 2px solid #ddd; }
    .btn-danger { margin-left: auto; }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
    </head>
    <body>
        <div class="container">
            <div class="form-section">
                <h2 class="mb-4">Edit Student</h2>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <label for="classSelect" class="form-label">Class</label>
                        <select id="classSelect" class="form-select"></select>
                    </div>
                    <div class="col-md-6">
                        <label for="rollSelect" class="form-label">Roll Number</label>
                        <select id="rollSelect" class="form-select"></select>
                    </div>
                </div>
                <div id="studentForm" style="display:none;">
                    <div class="mb-3">
                        <label for="studentName" class="form-label">Student Name</label>
                        <input type="text" id="studentName" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Photo</label>
                        <br>
                        <img id="photoPreview" class="photo-preview mb-2" src="#" alt="Photo Preview"/>
                        <input type="file" id="photoInput" accept="image/*" class="form-control">
                    </div>
                    <div id="subjectsContainer" class="mb-3"></div>
                    <button class="btn btn-secondary mb-3" id="addSubjectBtn">+ Add Subject</button>
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" id="saveBtn">Save Changes</button>
                        <button class="btn btn-danger" id="deleteBtn">Delete Student</button>
                    </div>
                </div>
            </div>
        </div>
        <script>
const api = 'https://script.google.com/macros/s/AKfycbxvo29JmLddIkeoJx_Ie9rI2OtJeLC9gdPuVciFecggYLZc8KXvgv4-lChFQD57LLsCCQ/exec';
let studentPhotoUrl = '', studentSubjects = [];

const classSelect = document.getElementById('classSelect');
const rollSelect = document.getElementById('rollSelect');
const studentName = document.getElementById('studentName');
const photoPreview = document.getElementById('photoPreview');
const photoInput = document.getElementById('photoInput');
const subjectsContainer = document.getElementById('subjectsContainer');
const studentForm = document.getElementById('studentForm');

// Populate class dropdown
fetch(api + '?action=getClasses')
  .then(res => res.json())
  .then(classes => {
    classSelect.innerHTML = `<option disabled selected>Select Class</option>` + 
      classes.map(cls => `<option value="${cls}">${cls}</option>`).join('');
  });

classSelect.addEventListener('change', () => {
  rollSelect.innerHTML = '';
  fetch(`${api}?action=getRolls&class=${classSelect.value}`)
    .then(res => res.json())
    .then(rolls => {
      rollSelect.innerHTML = `<option disabled selected>Select Roll</option>` +
        rolls.map(r => `<option value="${r}">${r}</option>`).join('');
    });
});

rollSelect.addEventListener('change', () => {
  const cls = classSelect.value, roll = rollSelect.value;
  fetch(`${api}?action=getStudent&class=${cls}&roll=${roll}`)
    .then(res => res.json())
    .then(data => {
      studentName.value = data.name;
      studentPhotoUrl = data.photoUrl;
      photoPreview.src = studentPhotoUrl;
      studentSubjects = data.subjects || [];

      subjectsContainer.innerHTML = '';
      studentSubjects.forEach((subj, i) => addSubjectRow(subj.subject, subj.marks, i));
      studentForm.style.display = 'block';
    });
});

function addSubjectRow(subject = '', marks = '', index = null) {
  const div = document.createElement('div');
  div.className = 'subject-row';
  div.innerHTML = `
    <input type="text" class="form-control subject" placeholder="Subject" value="${subject}">
    <input type="number" class="form-control marks" placeholder="Marks" value="${marks}">
    <button class="btn btn-danger btn-sm remove-btn">X</button>
  `;
  div.querySelector('.remove-btn').onclick = () => div.remove();
  subjectsContainer.appendChild(div);
}

document.getElementById('addSubjectBtn').addEventListener('click', () => addSubjectRow());

// Upload photo if updated
async function uploadPhotoIfNeeded() {
  if (!photoInput.files.length) return studentPhotoUrl;

  const formData = new FormData();
  formData.append('photo', photoInput.files[0]);
  formData.append('action', 'uploadPhoto');

  const response = await fetch(api, { method: 'POST', body: formData });
  const result = await response.json();
  return result.photoUrl || studentPhotoUrl;
}

// Save student
document.getElementById('saveBtn').addEventListener('click', async () => {
  const cls = classSelect.value, roll = rollSelect.value;
  const name = studentName.value.trim();
  const photoUrl = await uploadPhotoIfNeeded();

  const subjects = [...subjectsContainer.querySelectorAll('.subject-row')].map(row => {
    return {
      subject: row.querySelector('.subject').value.trim(),
      marks: row.querySelector('.marks').value.trim()
    };
  });

  const payload = { action: 'updateStudent', class: cls, roll, name, photoUrl, subjects };

  fetch(api, {
    method: 'POST',
    body: JSON.stringify(payload),
    headers: { 'Content-Type': 'application/json' }
  }).then(() => alert('Updated successfully'));
});

// Delete student
document.getElementById('deleteBtn').addEventListener('click', () => {
  const cls = classSelect.value, roll = rollSelect.value;
  if (confirm('Are you sure you want to delete this student?')) {
    fetch(api + `?action=deleteStudent&class=${cls}&roll=${roll}`)
      .then(() => {
        alert('Deleted successfully');
        location.reload();
      });
  }
});
</script>
    </body>
</html>

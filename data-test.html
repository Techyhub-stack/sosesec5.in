<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Student Records</title>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"/>
        <style>
    body {
      background-color: #f4f6f9;
      font-family: 'Segoe UI', sans-serif;
      padding: 2rem;
    }
    .container-box {
      background: white;
      padding: 2rem;
      border-radius: 10px;
      box-shadow: 0 0 12px rgba(0,0,0,0.05);
      animation: fadeIn 0.5s ease-in-out;
    }
    table {
      margin-top: 1rem;
    }
    img.photo {
      width: 60px;
      height: 60px;
      object-fit: cover;
      border-radius: 50%;
      border: 2px solid #ccc;
    }
    .mark-btn {
      cursor: pointer;
      color: #0d6efd;
      text-decoration: underline;
    }
    .modal-header {
      background: #0d6efd;
      color: white;
    }
    .modal-body table td, .modal-body table th {
      text-align: center;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
    </head>
    <body>
        <div class="container container-box">
            <h2 class="mb-4">Student Records</h2>
            <div class="row mb-3">
                <div class="col-md-4">
                    <select id="classSelect" class="form-select">
                        <option selected disabled>Select Class</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" id="searchInput" placeholder="Search by Roll Number or Name" class="form-control"/>
                </div>
                <div class="col-md-4 text-end">
                    <button class="btn btn-success" id="downloadBtn">Download CSV</button>
                </div>
            </div>
            <table class="table table-bordered table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Photo</th>
                        <th>Roll No</th>
                        <th>Name</th>
                        <th>Marks</th>
                    </tr>
                </thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        <!-- Modal -->
        <div class="modal fade" id="marksModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Subject-wise Marks</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p><strong>Name:</strong> <span id="modalName"></span></p>
                        <p><strong>Roll No:</strong> <span id="modalRoll"></span></p>
                        <table class="table table-sm table-striped">
                            <thead>
                                <tr>
                                    <th>Subject</th>
                                    <th>Marks</th>
                                </tr>
                            </thead>
                            <tbody id="subjectTable"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
        <script>
const api = 'https://script.google.com/macros/s/AKfycbxvo29JmLddIkeoJx_Ie9rI2OtJeLC9gdPuVciFecggYLZc8KXvgv4-lChFQD57LLsCCQ/exec';
let allData = [], currentClass = '';

const classSelect = document.getElementById('classSelect');
const searchInput = document.getElementById('searchInput');
const tableBody = document.getElementById('tableBody');
const downloadBtn = document.getElementById('downloadBtn');

// Populate class dropdown
fetch(api + '?action=getClasses')
  .then(res => res.json())
  .then(classes => {
    classSelect.innerHTML += classes.map(cls => `<option value="${cls}">${cls}</option>`).join('');
  });

classSelect.addEventListener('change', () => {
  currentClass = classSelect.value;
  fetch(`${api}?action=getClassData&class=${currentClass}`)
    .then(res => res.json())
    .then(data => {
      allData = mergeStudents(data);
      renderTable(allData);
    });
});

searchInput.addEventListener('input', () => {
  const query = searchInput.value.toLowerCase();
  const filtered = allData.filter(s =>
    s.name.toLowerCase().includes(query) ||
    s.rollNo.toString().includes(query)
  );
  renderTable(filtered);
});

function mergeStudents(rows) {
  const map = {};
  rows.forEach(row => {
    const key = row.rollNo;
    if (!map[key]) {
      map[key] = {
        rollNo: row.rollNo,
        name: row.name,
        photoUrl: row.photoUrl,
        subjects: []
      };
    }
    map[key].subjects.push({ subject: row.subject, marks: row.marks });
  });
  return Object.values(map);
}

function renderTable(data) {
  tableBody.innerHTML = '';
  data.forEach(student => {
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${student.photoUrl}" class="photo"/></td>
      <td>${student.rollNo}</td>
      <td>${student.name}</td>
      <td><span class="mark-btn" data-roll="${student.rollNo}">View</span></td>
    `;
    tableBody.appendChild(tr);
  });

  document.querySelectorAll('.mark-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      const student = data.find(s => s.rollNo == btn.dataset.roll);
      showModal(student);
    });
  });
}

function showModal(student) {
  document.getElementById('modalName').textContent = student.name;
  document.getElementById('modalRoll').textContent = student.rollNo;
  const subjectTable = document.getElementById('subjectTable');
  subjectTable.innerHTML = student.subjects.map(sub =>
    `<tr><td>${sub.subject}</td><td>${sub.marks}</td></tr>`
  ).join('');
  new bootstrap.Modal(document.getElementById('marksModal')).show();
}

downloadBtn.addEventListener('click', () => {
  if (!currentClass || allData.length === 0) return;
  let csv = "Roll Number,Name,Subject,Marks\n";
  allData.forEach(s => {
    s.subjects.forEach(sub => {
      csv += `${s.rollNo},"${s.name}",${sub.subject},${sub.marks}\n`;
    });
  });
  const blob = new Blob([csv], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `${currentClass}_records.csv`;
  a.click();
});
</script>
    </body>
</html>

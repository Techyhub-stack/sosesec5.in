<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <title>Edit Student Records</title>
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      padding: 20px;
      animation: fadeIn 0.6s ease-in;
    }

    h2 {
      text-align: center;
      color: #2b5876;
    }

    select, input, button {
      margin: 6px;
      padding: 10px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 1rem;
    }

    .container {
      display: flex;
      gap: 40px;
      flex-wrap: wrap;
    }

    .box {
      flex: 1;
      min-width: 300px;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .photo-preview {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 50%;
      margin: 10px 0;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
    </head>
    <body>
        <h2>Manage Student Records</h2>
        <div class="container">
            <div class="box">
                <h3>Edit Existing Student</h3>
                <select id="edit-class-select"></select>
                <select id="roll-select"></select>
                <input type="text" id="edit-name" placeholder="Student Name"/>
                <img id="edit-preview" class="photo-preview"/>
                <input type="file" id="edit-photo" accept="image/*"/>
                <div id="edit-subjects"></div>
                <input type="text" id="new-subject" placeholder="Subject Name"/>
                <input type="number" id="new-marks" placeholder="Marks"/>
                <button onclick="addSubject()">Add Subject</button>
                <br/>
                <button onclick="updateStudent()">Update Student</button>
                <button onclick="deleteStudent()">Delete Student</button>
            </div>
            <div class="box">
                <h3>Add New Student</h3>
                <select id="add-class-select"></select>
                <input type="text" id="new-roll" placeholder="Roll Number"/>
                <input type="text" id="new-name" placeholder="Student Name"/>
                <input type="file" id="new-photo" accept="image/*"/>
                <div id="new-subjects-container"></div>
                <input type="text" id="subject-name" placeholder="Subject Name"/>
                <input type="number" id="subject-marks" placeholder="Marks"/>
                <button onclick="addNewSubject()">Add Subject</button>
                <br/>
                <button onclick="addStudent()">Add Student</button>
            </div>
        </div>
        <script>
    const endpoint = 'https://script.google.com/macros/s/AKfycbyLzP6YACybvuJ97wzxEdsT8L6HPRLD7Hi-10BiJINKzzXUbtlQrej1O6QzH8jKl8uCcQ/exec';

    const editClassSelect = document.getElementById('edit-class-select');
    const rollSelect = document.getElementById('roll-select');
    const editName = document.getElementById('edit-name');
    const editPhotoInput = document.getElementById('edit-photo');
    const editPreview = document.getElementById('edit-preview');
    const editSubjectsDiv = document.getElementById('edit-subjects');
    let currentSubjects = [];

    const addClassSelect = document.getElementById('add-class-select');
    const newSubjectsContainer = document.getElementById('new-subjects-container');
    let newSubjects = [];

    const classNames = ['Class_10_A', 'Class_10_B', 'Class_10_C', 'Class_10_D',
                        'Class_11_A', 'Class_11_B', 'Class_11_C', 'Class_11_D',
                        'Class_12_A', 'Class_12_B', 'Class_12_C', 'Class_12_D'];

    function populateClassDropdowns() {
      classNames.forEach(cls => {
        editClassSelect.innerHTML += `<option value="${cls}">${cls}</option>`;
        addClassSelect.innerHTML += `<option value="${cls}">${cls}</option>`;
      });
    }

    async function fetchRolls() {
      const cls = editClassSelect.value;
      const res = await fetch(`${endpoint}?action=getRolls&class=${cls}`);
      const data = await res.json();
      rollSelect.innerHTML = '<option>Select</option>';
      data.forEach(s => {
        rollSelect.innerHTML += `<option value="${s.rollNo}">${s.rollNo}</option>`;
      });
    }

    async function fetchStudent() {
      const cls = editClassSelect.value;
      const roll = rollSelect.value;
      const res = await fetch(`${endpoint}?action=getStudent&class=${cls}&roll=${roll}`);
      const data = await res.json();
      editName.value = data.name || '';
      editPreview.src = data.photoUrl || '';
      currentSubjects = data.subjects || [];
      renderSubjectList();
    }

    function renderSubjectList() {
      editSubjectsDiv.innerHTML = '';
      currentSubjects.forEach((s, i) => {
        editSubjectsDiv.innerHTML += `
          <div>
            ${s.subject}: <input value="${s.marks}" onchange="updateMarks(${i}, this.value)" />
            <button onclick="deleteSubject(${i})">‚ùå</button>
          </div>`;
      });
    }

    function updateMarks(i, val) {
      currentSubjects[i].marks = parseInt(val);
    }

    function deleteSubject(i) {
      currentSubjects.splice(i, 1);
      renderSubjectList();
    }

    function addSubject() {
      const subject = document.getElementById('new-subject').value;
      const marks = parseInt(document.getElementById('new-marks').value);
      currentSubjects.push({ subject, marks });
      renderSubjectList();
    }

    async function updateStudent() {
      const cls = editClassSelect.value;
      const roll = rollSelect.value;
      const name = editName.value;
      const photo = editPhotoInput.files[0];
      const form = new FormData();
      form.append('action', 'updateStudent');
      form.append('class', cls);
      form.append('roll', roll);
      form.append('name', name);
      form.append('subjects', JSON.stringify(currentSubjects));
      if (photo) form.append('photo', photo);
      await fetch(endpoint, { method: 'POST', body: form });
      alert('Student updated!');
    }

    async function deleteStudent() {
      const cls = editClassSelect.value;
      const roll = rollSelect.value;
      await fetch(`${endpoint}?action=deleteStudent&class=${cls}&roll=${roll}`);
      alert('Student deleted!');
    }

    function addNewSubject() {
      const s = document.getElementById('subject-name').value;
      const m = parseInt(document.getElementById('subject-marks').value);
      newSubjects.push({ subject: s, marks: m });
      renderNewSubjects();
    }

    function renderNewSubjects() {
      newSubjectsContainer.innerHTML = '';
      newSubjects.forEach((s, i) => {
        newSubjectsContainer.innerHTML += `<div>${s.subject}: ${s.marks}</div>`;
      });
    }

    async function addStudent() {
      const cls = addClassSelect.value;
      const roll = document.getElementById('new-roll').value;
      const name = document.getElementById('new-name').value;
      const photo = document.getElementById('new-photo').files[0];
      const form = new FormData();
      form.append('action', 'addStudent');
      form.append('class', cls);
      form.append('roll', roll);
      form.append('name', name);
      form.append('subjects', JSON.stringify(newSubjects));
      if (photo) form.append('photo', photo);
      await fetch(endpoint, { method: 'POST', body: form });
      alert('Student added!');
    }

    editClassSelect.onchange = fetchRolls;
    rollSelect.onchange = fetchStudent;

    populateClassDropdowns();
  </script>
    </body>
</html>

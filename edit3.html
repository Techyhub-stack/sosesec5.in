<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8"/>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <title>Edit Student Records</title>
        <style>body {
    font-family: 'Segoe UI', sans-serif;
    background: #f4f4f9;
    padding: 30px;
}

h2 {
    text-align: center;
    margin-bottom: 30px;
}

select,
input,
button {
    margin-bottom: 10px;
    padding: 10px;
    width: 100%;
    border-radius: 6px;
    border: 1px solid #ccc;
}

.form-section {
    max-width: 600px;
    margin: auto;
    background: white;
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.05);
    margin-bottom: 40px;
}

.subject-pair {
    display: flex;
    gap: 10px;
}

.subject-pair input {
    flex: 1;
}

.photo-preview {
    margin-top: 10px;
}

img {
    width: 80px;
    height: 80px;
    object-fit: cover;
    border-radius: 6px;
    border: 1px solid #ccc;
}

.btn-add,
.btn-submit,
.btn-delete {
    background-color: #2b5876;
    color: white;
    border: none;
    cursor: pointer;
    font-weight: bold;
}

.btn-delete {
    background-color: #e74c3c;
}

.btn-add:hover,
.btn-submit:hover {
    background-color: #4e4376;
}

.btn-delete:hover {
    background-color: #c0392b;
}</style>
    </head>
    <body>
        <h2>Edit Student Records</h2>
        <div class="form-section">
            <label>Select Class:</label>
            <select id="classSelect">
                <option value="">-- Select Class --</option>
            </select>
            <label>Select Roll Number:</label>
            <select id="rollSelect">
                <option value="">-- Select Roll No --</option>
            </select>
            <button id="fetchBtn" class="btn-submit">Fetch Student</button>
            <div id="editForm" style="display: none;">
                <label>Student Name:</label>
                <input type="text" id="nameEdit" placeholder="Name"/>
                <div id="subjectMarksEdit"></div>
                <button id="addSubjectBtnEdit" class="btn-add">Add Subject</button>
                <label>Photo:</label>
                <input type="file" id="photoEdit" accept="image/*"/>
                <div class="photo-preview">
                    <img id="photoPreviewEdit" src="" alt="No Photo"/>
                </div>
                <button id="saveEditBtn" class="btn-submit">Save Changes</button>
                <button id="deleteBtn" class="btn-delete">Delete Student</button>
            </div>
        </div>
        <div class="form-section">
            <h3>Add New Student</h3>
            <label>Class:</label>
            <select id="newClassSelect">
                <option value="">-- Select Class --</option>
            </select>
            <label>Roll Number:</label>
            <input type="number" id="rollInput" placeholder="Roll Number"/>
            <label>Student Name:</label>
            <input type="text" id="nameInput" placeholder="Name"/>
            <div id="subjectMarksNew"></div>
            <button id="addSubjectBtnNew" class="btn-add">Add Subject</button>
            <label>Photo:</label>
            <input type="file" id="photoInput" accept="image/*"/>
            <button id="addBtn" class="btn-submit">Add Student</button>
        </div>
        <script>
    const endpoint = "https://script.google.com/macros/s/AKfycbxorHUsoZUuaMluss3-LfqiYPDqRMIt5rNmVDS1Q9zRhv8sfsfgOqwsTY15XO5BcKZbkQ/exec";

    const classSelect = document.getElementById("classSelect");
    const rollSelect = document.getElementById("rollSelect");
    const fetchBtn = document.getElementById("fetchBtn");

    const nameEdit = document.getElementById("nameEdit");
    const subjectMarksEdit = document.getElementById("subjectMarksEdit");
    const photoEdit = document.getElementById("photoEdit");
    const photoPreviewEdit = document.getElementById("photoPreviewEdit");
    const saveEditBtn = document.getElementById("saveEditBtn");
    const deleteBtn = document.getElementById("deleteBtn");

    const newClassSelect = document.getElementById("newClassSelect");
    const rollInput = document.getElementById("rollInput");
    const nameInput = document.getElementById("nameInput");
    const subjectMarksNew = document.getElementById("subjectMarksNew");
    const photoInput = document.getElementById("photoInput");
    const addBtn = document.getElementById("addBtn");

    const addSubjectBtnNew = document.getElementById("addSubjectBtnNew");
    const addSubjectBtnEdit = document.getElementById("addSubjectBtnEdit");

    const editForm = document.getElementById("editForm");

    const classes = ["Class_10_A", "Class_10_B", "Class_10_C", "Class_10_D", "Class_11_A", "Class_11_B", "Class_11_C", "Class_11_D", "Class_12_A", "Class_12_B", "Class_12_C", "Class_12_D"];

    function populateClassDropdowns() {
      classes.forEach(cls => {
        const option1 = new Option(cls, cls);
        const option2 = new Option(cls, cls);
        classSelect.appendChild(option1);
        newClassSelect.appendChild(option2);
      });
    }

    function createSubjectRow(container, subject = '', marks = '') {
      const div = document.createElement('div');
      div.className = 'subject-pair';
      div.innerHTML = `
        <input type="text" placeholder="Subject" value="${subject}" class="subject" />
        <input type="number" placeholder="Marks" value="${marks}" class="marks" />
      `;
      container.appendChild(div);
    }

    function uploadPhoto(file) {
      const form = new FormData();
      form.append('photo', file);
      return fetch(endpoint, {
        method: 'POST',
        body: form
      })
      .then(res => res.json())
      .then(data => data.photoUrl || '');
    }

    classSelect.addEventListener('change', () => {
      const selectedClass = classSelect.value;
      rollSelect.innerHTML = '<option value="">-- Select Roll No --</option>';
      if (!selectedClass) return;
      fetch(`${endpoint}?action=getRolls&class=${selectedClass}`)
        .then(res => res.json())
        .then(rolls => {
          rolls.forEach(r => {
            const opt = new Option(r.rollNo, r.rollNo);
            rollSelect.appendChild(opt);
          });
        });
    });

    fetchBtn.addEventListener('click', () => {
      const cls = classSelect.value;
      const roll = rollSelect.value;
      if (!cls || !roll) return;
      fetch(`${endpoint}?action=getStudent&class=${cls}&rollNo=${roll}`)
        .then(res => res.json())
        .then(student => {
          nameEdit.value = student.name || '';
          photoPreviewEdit.src = student.photoUrl || '';
          subjectMarksEdit.innerHTML = '';
          (student.subjects || []).forEach(pair => createSubjectRow(subjectMarksEdit, pair.subject, pair.marks));
          editForm.style.display = 'block';
        });
    });

    addSubjectBtnNew.addEventListener('click', () => createSubjectRow(subjectMarksNew));
    addSubjectBtnEdit.addEventListener('click', () => createSubjectRow(subjectMarksEdit));

    addBtn.addEventListener('click', async () => {
      const cls = newClassSelect.value;
      const roll = rollInput.value.trim();
      const name = nameInput.value.trim();
      const file = photoInput.files[0];
      if (!cls || !roll || !name) return alert("All fields required");
      const subjects = [...subjectMarksNew.querySelectorAll('.subject-pair')].map(row => {
        return {
          subject: row.querySelector('.subject').value.trim(),
          marks: row.querySelector('.marks').value.trim()
        };
      });

      let photoUrl = '';
      if (file) photoUrl = await uploadPhoto(file);

      fetch(endpoint, {
        method: 'POST',
        body: JSON.stringify({
          action: 'addStudent',
          class: cls,
          rollNo: roll,
          name,
          photoUrl,
          subjects
        })
      }).then(() => alert("Student Added"));
    });

    saveEditBtn.addEventListener('click', async () => {
      const cls = classSelect.value;
      const roll = rollSelect.value;
      const name = nameEdit.value.trim();
      const file = photoEdit.files[0];
      if (!cls || !roll || !name) return;
      const subjects = [...subjectMarksEdit.querySelectorAll('.subject-pair')].map(row => {
        return {
          subject: row.querySelector('.subject').value.trim(),
          marks: row.querySelector('.marks').value.trim()
        };
      });

      let photoUrl = photoPreviewEdit.src;
      if (file) photoUrl = await uploadPhoto(file);

      fetch(endpoint, {
        method: 'POST',
        body: JSON.stringify({
          action: 'updateStudent',
          class: cls,
          rollNo: roll,
          name,
          photoUrl,
          subjects
        })
      }).then(() => alert("Student Updated"));
    });

    deleteBtn.addEventListener('click', () => {
      const cls = classSelect.value;
      const roll = rollSelect.value;
      if (confirm("Are you sure you want to delete this student?")) {
        fetch(endpoint, {
          method: 'POST',
          body: JSON.stringify({
            action: 'deleteStudent',
            class: cls,
            rollNo: roll
          })
        }).then(() => alert("Student Deleted"));
      }
    });

    populateClassDropdowns();
  </script>
    </body>
</html>
